<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® DEBUG EMERG√àNCIA - Ifercat Contractaci√≥ P√∫blica</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #ff4444;
            border-bottom: 2px solid #ff4444;
            padding-bottom: 10px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }
        .status-card h2 {
            margin-top: 0;
            color: #007BFF;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .status-ok { color: #4CAF50; }
        .status-error { color: #ff4444; }
        .status-warning { color: #FFC107; }
        .console-output {
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .action-buttons {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd93d; }
        .log-success { color: #6bcf7f; }
        .log-info { color: #74c0fc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® PANELL DE DEPURACI√ì D'EMERG√àNCIA</h1>
        <p>Ifercat - Contractaci√≥ P√∫blica | Incident P0 | <span id="timestamp"></span></p>
        
        <div class="action-buttons">
            <button onclick="runFullDiagnostic()">üîç Diagn√≤stic Complet</button>
            <button onclick="checkScripts()">üìú Verificar Scripts</button>
            <button onclick="checkAPI()">üåê Test API</button>
            <button onclick="clearAllData()">üóëÔ∏è Netejar Dades</button>
            <button onclick="forceReload()" class="danger">üîÑ For√ßar Rec√†rrega</button>
            <button onclick="killAllServers()">‚ö° Matar Servidors</button>
        </div>

        <div class="status-grid">
            <!-- Estat dels Scripts -->
            <div class="status-card">
                <h2>üìú Estat dels Scripts</h2>
                <div id="scripts-status">
                    <div class="status-item">
                        <span>Carregant...</span>
                        <span class="status-warning">‚è≥</span>
                    </div>
                </div>
            </div>

            <!-- Estat de l'Aplicaci√≥ -->
            <div class="status-card">
                <h2>üöÄ Estat de l'Aplicaci√≥</h2>
                <div id="app-status">
                    <div class="status-item">
                        <span>Carregant...</span>
                        <span class="status-warning">‚è≥</span>
                    </div>
                </div>
            </div>

            <!-- Errors de Consola -->
            <div class="status-card">
                <h2>‚ö†Ô∏è Errors Detectats</h2>
                <div id="console-errors" class="console-output">
                    <div class="log-info">Esperant errors...</div>
                </div>
            </div>

            <!-- Estat de la Xarxa -->
            <div class="status-card">
                <h2>üåê Estat de la Xarxa</h2>
                <div id="network-status">
                    <div class="status-item">
                        <span>Carregant...</span>
                        <span class="status-warning">‚è≥</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-card">
            <h2>üìä Log Complet</h2>
            <div id="full-log" class="console-output" style="max-height: 500px;">
                <div class="log-info">üöÄ Iniciant diagn√≤stic d'emerg√®ncia...</div>
            </div>
        </div>
    </div>

    <script>
        // Capturar errors globals
        let errorCount = 0;
        window.addEventListener('error', (e) => {
            errorCount++;
            logError(`Error ${errorCount}: ${e.message} a ${e.filename}:${e.lineno}:${e.colno}`);
            updateErrorDisplay(e);
        });

        window.addEventListener('unhandledrejection', (e) => {
            errorCount++;
            logError(`Promise Rebutjada ${errorCount}: ${e.reason}`);
        });

        // Logging functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('full-log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function logError(message) { log(message, 'error'); }
        function logWarning(message) { log(message, 'warning'); }
        function logSuccess(message) { log(message, 'success'); }
        function logInfo(message) { log(message, 'info'); }

        // Update timestamp
        setInterval(() => {
            document.getElementById('timestamp').textContent = new Date().toLocaleString('ca-ES');
        }, 1000);

        // Diagnostic functions
        function checkScripts() {
            logInfo('üîç Verificant scripts carregats...');
            const scripts = {
                'ContentLoader': typeof ContentLoader !== 'undefined',
                'Chatbot': typeof Chatbot !== 'undefined',
                'App': typeof App !== 'undefined',
                'AOS': typeof AOS !== 'undefined',
                'marked': typeof marked !== 'undefined',
                'Chart': typeof Chart !== 'undefined'
            };

            const container = document.getElementById('scripts-status');
            container.innerHTML = '';

            Object.entries(scripts).forEach(([name, loaded]) => {
                const item = document.createElement('div');
                item.className = 'status-item';
                item.innerHTML = `
                    <span>${name}</span>
                    <span class="${loaded ? 'status-ok' : 'status-error'}">${loaded ? '‚úÖ' : '‚ùå'}</span>
                `;
                container.appendChild(item);
                
                if (loaded) {
                    logSuccess(`‚úÖ ${name} carregat correctament`);
                } else {
                    logError(`‚ùå ${name} NO CARREGAT`);
                }
            });

            // Verificar scripts al DOM
            const scriptTags = document.querySelectorAll('script[src]');
            logInfo(`üìú Total scripts al DOM: ${scriptTags.length}`);
            scriptTags.forEach(script => {
                logInfo(`   - ${script.src}`);
            });
        }

        function checkAPI() {
            logInfo('üåê Verificant connectivitat API...');
            
            const networkStatus = document.getElementById('network-status');
            networkStatus.innerHTML = '<div class="status-item"><span>Provant connexi√≥...</span><span class="status-warning">‚è≥</span></div>';

            // Test OpenRouter API
            fetch('https://openrouter.ai/api/v1/models', {
                method: 'GET',
                headers: {
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Contractaci√≥ P√∫blica Test'
                }
            })
            .then(response => {
                if (response.ok) {
                    logSuccess('‚úÖ API OpenRouter accessible');
                    networkStatus.innerHTML = '<div class="status-item"><span>OpenRouter API</span><span class="status-ok">‚úÖ</span></div>';
                } else {
                    logError(`‚ùå API OpenRouter error: ${response.status}`);
                    networkStatus.innerHTML = '<div class="status-item"><span>OpenRouter API</span><span class="status-error">‚ùå ' + response.status + '</span></div>';
                }
            })
            .catch(error => {
                logError(`‚ùå Error de xarxa: ${error.message}`);
                networkStatus.innerHTML = '<div class="status-item"><span>Error de xarxa</span><span class="status-error">‚ùå</span></div>';
            });

            // Test local server
            fetch('/api/health', { method: 'GET' })
                .then(() => {
                    logSuccess('‚úÖ Servidor local respon');
                    networkStatus.innerHTML += '<div class="status-item"><span>Servidor Local</span><span class="status-ok">‚úÖ</span></div>';
                })
                .catch(() => {
                    logWarning('‚ö†Ô∏è Endpoint /api/health no disponible (normal en dev)');
                    networkStatus.innerHTML += '<div class="status-item"><span>Servidor Local</span><span class="status-warning">‚ö†Ô∏è</span></div>';
                });
        }

        function checkAppStatus() {
            logInfo('üöÄ Verificant estat de l\'aplicaci√≥...');
            const container = document.getElementById('app-status');
            container.innerHTML = '';

            const checks = {
                'window.app': window.app !== undefined,
                'DOM Carregat': document.readyState === 'complete',
                'LocalStorage': (() => {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        return true;
                    } catch {
                        return false;
                    }
                })(),
                'SessionStorage': (() => {
                    try {
                        sessionStorage.setItem('test', 'test');
                        sessionStorage.removeItem('test');
                        return true;
                    } catch {
                        return false;
                    }
                })(),
                'Cookies Habilitades': navigator.cookieEnabled
            };

            Object.entries(checks).forEach(([name, ok]) => {
                const item = document.createElement('div');
                item.className = 'status-item';
                item.innerHTML = `
                    <span>${name}</span>
                    <span class="${ok ? 'status-ok' : 'status-error'}">${ok ? '‚úÖ' : '‚ùå'}</span>
                `;
                container.appendChild(item);
            });

            // Verificar elements cr√≠tics del DOM
            const criticalElements = ['loading-screen', 'navbar', 'chat', 'chat-input', 'chat-messages'];
            logInfo('üèóÔ∏è Verificant elements cr√≠tics del DOM...');
            criticalElements.forEach(id => {
                const exists = document.getElementById(id) !== null;
                if (exists) {
                    logSuccess(`‚úÖ Element #${id} trobat`);
                } else {
                    logError(`‚ùå Element #${id} NO TROBAT`);
                }
            });
        }

        function updateErrorDisplay(error) {
            const container = document.getElementById('console-errors');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'log-error';
            errorDiv.textContent = `${error.message} (${error.filename}:${error.lineno})`;
            container.appendChild(errorDiv);
            if (container.children.length > 10) {
                container.removeChild(container.firstChild);
            }
        }

        function runFullDiagnostic() {
            logInfo('üö® INICIANT DIAGN√íSTIC COMPLET...');
            checkScripts();
            setTimeout(() => checkAPI(), 500);
            setTimeout(() => checkAppStatus(), 1000);
            
            // Informaci√≥ del navegador
            setTimeout(() => {
                logInfo('üåê Informaci√≥ del navegador:');
                logInfo(`   - User Agent: ${navigator.userAgent}`);
                logInfo(`   - Plataforma: ${navigator.platform}`);
                logInfo(`   - Idioma: ${navigator.language}`);
                logInfo(`   - Cookies: ${navigator.cookieEnabled ? 'Habilitades' : 'Deshabilitades'}`);
                logInfo(`   - Online: ${navigator.onLine ? 'S√≠' : 'No'}`);
            }, 1500);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Aix√≤ esborrar√† totes les dades locals. Est√†s segur?')) {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    logSuccess('‚úÖ Dades locals esborrades');
                    setTimeout(() => location.reload(), 1000);
                } catch (e) {
                    logError('‚ùå Error esborrant dades: ' + e.message);
                }
            }
        }

        function forceReload() {
            logWarning('üîÑ For√ßant rec√†rrega completa...');
            setTimeout(() => {
                location.reload(true);
            }, 500);
        }

        function killAllServers() {
            logWarning('‚ö° Intentant tancar tots els servidors locals...');
            logInfo('Executa aquestes comandes al terminal:');
            logInfo('Windows: netstat -ano | findstr :3000');
            logInfo('Windows: netstat -ano | findstr :3001');
            logInfo('Windows: netstat -ano | findstr :3002');
            logInfo('Windows: netstat -ano | findstr :3003');
            logInfo('Per matar un proc√©s: taskkill /PID [numero_pid] /F');
            
            // Copiar comandes al clipboard
            const commands = `netstat -ano | findstr :3000
netstat -ano | findstr :3001
netstat -ano | findstr :3002
netstat -ano | findstr :3003`;
            navigator.clipboard.writeText(commands).then(() => {
                logSuccess('‚úÖ Comandes copiades al portapapers');
            });
        }

        // Auto-run diagnostic on load
        window.addEventListener('load', () => {
            logSuccess('‚úÖ P√†gina de depuraci√≥ carregada');
            setTimeout(runFullDiagnostic, 1000);
        });
    </script>
</body>
</html> 